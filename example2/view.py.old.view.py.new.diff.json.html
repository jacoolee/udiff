
<style>
table {-webkit-border-horizontal-spacing: 0; -webkit-border-vertical-spacing: 0; font-family: monospace; cursor: default; }
td {white-space: pre; padding-left: 5px; border-bottom: solid 1px transparent; }
tr:hover > td { border-bottom: solid 1px black; }
.diff_header { background-color: green; color: white;}
.hunk_separator_pre:hover > td, .hunk_separator_pre > td { border-bottom: solid 1px blue; }
.ln_old,.ln_new {color: gray};
.type-mark {display: none; }
.mod {color: goldenrod; }
.del {color: red;}
.sam {}
.add {color: green;}
</style>

<table class="xx">
<tr><td/><td> --- view.py.old	2024-12-13 15:51:53                                    </td><td/><td/><td/></tr>
<tr><td/><td> +++ view.py.new	2024-12-13 15:52:04                                    </td><td/><td/><td/></tr>
<tr class="hunk_separator_pre"><td> </td><td/><td/><td/><td/></tr>
<tr><td/><td>@@ -1,25 +1,82 @@                                                     </td><td/><td/><td/></tr>
<tr><td> </td><td/><td/><td/><td/></tr>
<tr class='sam'><td class='ln_old'>    1</td><td>#! /usr/bin/env python                                                </td><td> </td><td class='ln_new'>    1</td><td>#! /usr/bin/env python                                                </td></tr>
<tr class='sam'><td class='ln_old'>    2</td><td># -*- coding: utf-8 -*-                                               </td><td> </td><td class='ln_new'>    2</td><td># -*- coding: utf-8 -*-                                               </td></tr>
<tr class='mod'><td class='ln_old'>    3</td><td>                                                                      </td><td>|</td><td class='ln_new'>    3</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>    4</td><td>from __future__ import unicode_literals                               </td><td> </td><td class='ln_new'>    4</td><td>from __future__ import unicode_literals                               </td></tr>
<tr class='sam'><td class='ln_old'>    5</td><td>import sys                                                            </td><td> </td><td class='ln_new'>    5</td><td>import sys                                                            </td></tr>
<tr class='sam'><td class='ln_old'>    6</td><td>reload(sys)                                                           </td><td> </td><td class='ln_new'>    6</td><td>reload(sys)                                                           </td></tr>
<tr class='sam'><td class='ln_old'>    7</td><td>sys.setdefaultencoding(&#39utf8&#39)                                        </td><td> </td><td class='ln_new'>    7</td><td>sys.setdefaultencoding(&#39utf8&#39)                                        </td></tr>
<tr class='mod'><td class='ln_old'>    8</td><td>                                                                      </td><td>|</td><td class='ln_new'>    8</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>    9</td><td>import json                                                           </td><td> </td><td class='ln_new'>    9</td><td>import json                                                           </td></tr>
<tr class='mod'><td class='ln_old'>   10</td><td>                                                                      </td><td>|</td><td class='ln_new'>   10</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   11</td><td>def usage():                                                          </td><td> </td><td class='ln_new'>   11</td><td>def usage():                                                          </td></tr>
<tr class='sam'><td class='ln_old'>   12</td><td>    print __file__, &quotold_file diff_json_file [--html] [--txt]&quot        </td><td> </td><td class='ln_new'>   12</td><td>    print __file__, &quotold_file diff_json_file [--html] [--txt]&quot        </td></tr>
<tr class='sam'><td class='ln_old'>   13</td><td>    sys.exit(-1)                                                      </td><td> </td><td class='ln_new'>   13</td><td>    sys.exit(-1)                                                      </td></tr>
<tr class='mod'><td class='ln_old'>   14</td><td>                                                                      </td><td>|</td><td class='ln_new'>   14</td><td>                                                                      </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   15</td><td>def _fli(i=None, max_len=5):                                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   16</td><td>    if i is None:                                                     </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   17</td><td>        return &#39 &#39*max_len                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   19</td><td>    fmt = &#39%&#39+str(max_len)+&#39d&#39                                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   20</td><td>    return fmt%(i)                                                    </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   22</td><td># string with fixed length                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   23</td><td>def _fls(txt=None, max_len=63):                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   24</td><td>    _txt = txt or &#39&#39                                                  </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   25</td><td>    if len(_txt) &lt max_len:                                           </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   26</td><td>        return _txt + &#39 &#39*(max_len-len(_txt))                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   27</td><td>    return _txt[0:max_len]                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   29</td><td>def html_escape(txt):                                                 </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   30</td><td>    # https://stackoverflow.com/questions/7381974/which-characters-nee</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>d-to-be-escaped-in-html#7382028                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   31</td><td>    return txt\                                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   32</td><td>        .replace(&#39&amp&#39, &#39&ampamp&#39)\                                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   33</td><td>        .replace(&#39&gt&#39, &#39&ampgt&#39)\                                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   34</td><td>        .replace(&#39&lt&#39, &#39&amplt&#39)\                                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   35</td><td>        .replace(&#39&quot&#39, &#39&ampquot&#39)\                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   36</td><td>        .replace(&quot&#39&quot, &#39&amp#39&#39)                                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   38</td><td>def render(ln_old, s_old, mark, ln_new=None, s_new=None, fli_max_len=5</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>, fls_max_length=63):                                                 </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   39</td><td>    if option_render_txt:                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   40</td><td>        print \                                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   41</td><td>            _fli(ln_old, max_len=fli_max_len), _fls(s_old, max_len=fls</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>_max_length), \                                                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   42</td><td>            mark, \                                                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   43</td><td>            _fli(ln_new, max_len=fli_max_len), _fls(s_new, max_len=fls</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>_max_length)                                                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   45</td><td>    elif option_render_html:                                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   46</td><td>        if mark == &#39 &#39:                                               </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   47</td><td>            tr_cls = &#39sam&#39                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   48</td><td>        elif mark == &#39+&#39:                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   49</td><td>            tr_cls = &#39add&#39                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   50</td><td>        elif mark == &#39-&#39:                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   51</td><td>            tr_cls = &#39del&#39                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   52</td><td>        elif mark == &#39|&#39:                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   53</td><td>            tr_cls = &#39mod&#39                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   54</td><td>        else:                                                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   55</td><td>            tr_cls = &#39&#39                                               </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   57</td><td>        print &quot&lttr class=&#39%s&#39&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>/td&gt&lttd&gt%s&lt/td&gt&lt/tr&gt&quot%(                                               </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   58</td><td>            tr_cls,                                                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   59</td><td>            _fli(ln_old, max_len=fli_max_len),                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   60</td><td>            html_escape(_fls(s_old, max_len=fls_max_length)),         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   61</td><td>            mark,                                                     </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   62</td><td>            _fli(ln_new, max_len=fli_max_len),                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   63</td><td>            html_escape(_fls(s_new, max_len=fls_max_length))          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   64</td><td>        )                                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   66</td><td>    else:                                                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   67</td><td>        pass                                                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   69</td><td>################################################################      </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>   70</td><td># main                                                                </td></tr>
<tr class='sam'><td class='ln_old'>   15</td><td>if len(sys.argv) &lt 2:                                                 </td><td> </td><td class='ln_new'>   72</td><td>if len(sys.argv) &lt 2:                                                 </td></tr>
<tr class='sam'><td class='ln_old'>   16</td><td>    usage()                                                           </td><td> </td><td class='ln_new'>   73</td><td>    usage()                                                           </td></tr>
<tr class='mod'><td class='ln_old'>   17</td><td>                                                                      </td><td>|</td><td class='ln_new'>   74</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   18</td><td>old_file = None                                                       </td><td> </td><td class='ln_new'>   75</td><td>old_file = None                                                       </td></tr>
<tr class='sam'><td class='ln_old'>   19</td><td>diff_json_file = None                                                 </td><td> </td><td class='ln_new'>   76</td><td>diff_json_file = None                                                 </td></tr>
<tr class='sam'><td class='ln_old'>   20</td><td>option_render_txt = False                                             </td><td> </td><td class='ln_new'>   77</td><td>option_render_txt = False                                             </td></tr>
<tr class='sam'><td class='ln_old'>   21</td><td>option_render_html = False                                            </td><td> </td><td class='ln_new'>   78</td><td>option_render_html = False                                            </td></tr>
<tr class='mod'><td class='ln_old'>   22</td><td>                                                                      </td><td>|</td><td class='ln_new'>   79</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   23</td><td>for i in sys.argv[1:]:                                                </td><td> </td><td class='ln_new'>   80</td><td>for i in sys.argv[1:]:                                                </td></tr>
<tr class='sam'><td class='ln_old'>   24</td><td>    if i.startswith(&#39-&#39):                                             </td><td> </td><td class='ln_new'>   81</td><td>    if i.startswith(&#39-&#39):                                             </td></tr>
<tr class='sam'><td class='ln_old'>   25</td><td>        if i == &#39--html&#39:                                             </td><td> </td><td class='ln_new'>   82</td><td>        if i == &#39--html&#39:                                             </td></tr>
<tr class="hunk_separator_pre"><td> </td><td/><td/><td/><td/></tr>
<tr><td/><td>@@ -29,46 +86,46 @@                                                   </td><td/><td/><td/></tr>
<tr><td> </td><td/><td/><td/><td/></tr>
<tr class='sam'><td class='ln_old'>   29</td><td>        else:                                                         </td><td> </td><td class='ln_new'>   86</td><td>        else:                                                         </td></tr>
<tr class='sam'><td class='ln_old'>   30</td><td>            pass                                                      </td><td> </td><td class='ln_new'>   87</td><td>            pass                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   31</td><td>        continue                                                      </td><td> </td><td class='ln_new'>   88</td><td>        continue                                                      </td></tr>
<tr class='mod'><td class='ln_old'>   32</td><td>                                                                      </td><td>|</td><td class='ln_new'>   89</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   33</td><td>    # files                                                           </td><td> </td><td class='ln_new'>   90</td><td>    # files                                                           </td></tr>
<tr class='sam'><td class='ln_old'>   34</td><td>    if old_file is None: # old_file comes first                       </td><td> </td><td class='ln_new'>   91</td><td>    if old_file is None: # old_file comes first                       </td></tr>
<tr class='sam'><td class='ln_old'>   35</td><td>        old_file = i                                                  </td><td> </td><td class='ln_new'>   92</td><td>        old_file = i                                                  </td></tr>
<tr class='sam'><td class='ln_old'>   36</td><td>    else:                                                             </td><td> </td><td class='ln_new'>   93</td><td>    else:                                                             </td></tr>
<tr class='sam'><td class='ln_old'>   37</td><td>        diff_json_file = i                                            </td><td> </td><td class='ln_new'>   94</td><td>        diff_json_file = i                                            </td></tr>
<tr class='mod'><td class='ln_old'>   38</td><td>                                                                      </td><td>|</td><td class='ln_new'>   95</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   39</td><td>if old_file is None or diff_json_file is None:                        </td><td> </td><td class='ln_new'>   96</td><td>if old_file is None or diff_json_file is None:                        </td></tr>
<tr class='sam'><td class='ln_old'>   40</td><td>    usage()                                                           </td><td> </td><td class='ln_new'>   97</td><td>    usage()                                                           </td></tr>
<tr class='mod'><td class='ln_old'>   41</td><td>                                                                      </td><td>|</td><td class='ln_new'>   98</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   42</td><td>if not option_render_txt and not option_render_html:                  </td><td> </td><td class='ln_new'>   99</td><td>if not option_render_txt and not option_render_html:                  </td></tr>
<tr class='sam'><td class='ln_old'>   43</td><td>    option_render_txt = True                                          </td><td> </td><td class='ln_new'>  100</td><td>    option_render_txt = True                                          </td></tr>
<tr class='mod'><td class='ln_old'>   44</td><td>                                                                      </td><td>|</td><td class='ln_new'>  101</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   45</td><td># https://en.wikipedia.org/wiki/Diff#Unified_format                   </td><td> </td><td class='ln_new'>  102</td><td># https://en.wikipedia.org/wiki/Diff#Unified_format                   </td></tr>
<tr class='sam'><td class='ln_old'>   46</td><td># https://www.gnu.org/software/diffutils/manual/html_node/Detailed-Uni</td><td> </td><td class='ln_new'>  103</td><td># https://www.gnu.org/software/diffutils/manual/html_node/Detailed-Uni</td></tr>
<tr class='sam'><td class='ln_old'>     </td><td>fied.html                                                             </td><td> </td><td class='ln_new'>     </td><td>fied.html                                                             </td></tr>
<tr class='sam'><td class='ln_old'>   47</td><td>diff_meta = None                                                      </td><td> </td><td class='ln_new'>  104</td><td>diff_meta = None                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   48</td><td>with open(diff_json_file, &quotr&quot) as f:                                  </td><td> </td><td class='ln_new'>  105</td><td>with open(diff_json_file, &quotr&quot) as f:                                  </td></tr>
<tr class='sam'><td class='ln_old'>   49</td><td>    diff_meta = json.load(f)                                          </td><td> </td><td class='ln_new'>  106</td><td>    diff_meta = json.load(f)                                          </td></tr>
<tr class='mod'><td class='ln_old'>   50</td><td>                                                                      </td><td>|</td><td class='ln_new'>  107</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   51</td><td>ops = diff_meta                                                       </td><td> </td><td class='ln_new'>  108</td><td>ops = diff_meta                                                       </td></tr>
<tr class='mod'><td class='ln_old'>   52</td><td>                                                                      </td><td>|</td><td class='ln_new'>  109</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   53</td><td>f = open(old_file, &quotr&quot)                                               </td><td> </td><td class='ln_new'>  110</td><td>f = open(old_file, &quotr&quot)                                               </td></tr>
<tr class='mod'><td class='ln_old'>   54</td><td>                                                                      </td><td>|</td><td class='ln_new'>  111</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   55</td><td>l_map = {}                                                            </td><td> </td><td class='ln_new'>  112</td><td>l_map = {}                                                            </td></tr>
<tr class='sam'><td class='ln_old'>   56</td><td>ln = 0                                                                </td><td> </td><td class='ln_new'>  113</td><td>ln = 0                                                                </td></tr>
<tr class='sam'><td class='ln_old'>   57</td><td>for l in f.readlines():                                               </td><td> </td><td class='ln_new'>  114</td><td>for l in f.readlines():                                               </td></tr>
<tr class='sam'><td class='ln_old'>   58</td><td>    ln += 1                     # ln starts from 1                    </td><td> </td><td class='ln_new'>  115</td><td>    ln += 1                     # ln starts from 1                    </td></tr>
<tr class='mod'><td class='ln_old'>   59</td><td>                                                                      </td><td>|</td><td class='ln_new'>  116</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   60</td><td>    l = l.replace(&#39\n&#39, &#39&#39)                                           </td><td> </td><td class='ln_new'>  117</td><td>    l = l.replace(&#39\n&#39, &#39&#39)                                           </td></tr>
<tr class='sam'><td class='ln_old'>   61</td><td>    l_map[ln] = l                                                     </td><td> </td><td class='ln_new'>  118</td><td>    l_map[ln] = l                                                     </td></tr>
<tr class='sam'><td class='ln_old'>   62</td><td>ln_old_total = ln                                                     </td><td> </td><td class='ln_new'>  119</td><td>ln_old_total = ln                                                     </td></tr>
<tr class='mod'><td class='ln_old'>   63</td><td>                                                                      </td><td>|</td><td class='ln_new'>  120</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   64</td><td>ln_old_last = 0                                                       </td><td> </td><td class='ln_new'>  121</td><td>ln_old_last = 0                                                       </td></tr>
<tr class='sam'><td class='ln_old'>   65</td><td>ln_new_last = 0                                                       </td><td> </td><td class='ln_new'>  122</td><td>ln_new_last = 0                                                       </td></tr>
<tr class='mod'><td class='ln_old'>   66</td><td>                                                                      </td><td>|</td><td class='ln_new'>  123</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>   67</td><td>if option_render_html:                                                </td><td> </td><td class='ln_new'>  124</td><td>if option_render_html:                                                </td></tr>
<tr class='sam'><td class='ln_old'>   68</td><td>    print &quot&quot&quot                                                         </td><td> </td><td class='ln_new'>  125</td><td>    print &quot&quot&quot                                                         </td></tr>
<tr class='sam'><td class='ln_old'>   69</td><td>&ltstyle&gt                                                               </td><td> </td><td class='ln_new'>  126</td><td>&ltstyle&gt                                                               </td></tr>
<tr class='sam'><td class='ln_old'>   70</td><td>table {-webkit-border-horizontal-spacing: 0; -webkit-border-vertical-s</td><td> </td><td class='ln_new'>  127</td><td>table {-webkit-border-horizontal-spacing: 0; -webkit-border-vertical-s</td></tr>
<tr class='sam'><td class='ln_old'>     </td><td>pacing: 0; font-family: monospace; }                                  </td><td> </td><td class='ln_new'>     </td><td>pacing: 0; font-family: monospace; }                                  </td></tr>
<tr class='mod'><td class='ln_old'>   71</td><td>td {border-bottom: solid 1px gray; padding-left: 5px; }               </td><td>|</td><td class='ln_new'>  128</td><td>td {white-space: pre; border-bottom: solid 1px gray; padding-left: 5px</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>; }                                                                   </td></tr>
<tr class='sam'><td class='ln_old'>   72</td><td>.type-mark {display: none; }                                          </td><td> </td><td class='ln_new'>  129</td><td>.type-mark {display: none; }                                          </td></tr>
<tr class='sam'><td class='ln_old'>   73</td><td>.mod {background-color: yellow; color: black; }                       </td><td> </td><td class='ln_new'>  130</td><td>.mod {background-color: yellow; color: black; }                       </td></tr>
<tr class='sam'><td class='ln_old'>   74</td><td>.del {background-color: red; color: white;}                           </td><td> </td><td class='ln_new'>  131</td><td>.del {background-color: red; color: white;}                           </td></tr>
<tr class="hunk_separator_pre"><td> </td><td/><td/><td/><td/></tr>
<tr><td/><td>@@ -76,129 +133,171 @@                                                </td><td/><td/><td/></tr>
<tr><td> </td><td/><td/><td/><td/></tr>
<tr class='sam'><td class='ln_old'>   76</td><td>.add {background-color: green; color: white;}                         </td><td> </td><td class='ln_new'>  133</td><td>.add {background-color: green; color: white;}                         </td></tr>
<tr class='sam'><td class='ln_old'>   77</td><td>&lt/style&gt                                                              </td><td> </td><td class='ln_new'>  134</td><td>&lt/style&gt                                                              </td></tr>
<tr class='sam'><td class='ln_old'>   78</td><td>&quot&quot&quot                                                                   </td><td> </td><td class='ln_new'>  135</td><td>&quot&quot&quot                                                                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  137</td><td>if option_render_html:                                                </td></tr>
<tr class='sam'><td class='ln_old'>   79</td><td>    print &#39&lttable&gt&#39                                                   </td><td> </td><td class='ln_new'>  138</td><td>    print &#39&lttable&gt&#39                                                   </td></tr>
<tr class='del'><td class='ln_old'>   80</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   81</td><td>def _fli(i=None, max_len=3):                                          </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   82</td><td>    if i is None:                                                     </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   83</td><td>        return &#39 &#39*max_len                                            </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   84</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   85</td><td>    fmt = &#39%&#39+str(max_len)+&#39d&#39                                        </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   86</td><td>    return fmt%(i)                                                    </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   87</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   88</td><td># string with fixed length                                            </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   89</td><td>def _fls(txt=None, max_len=63):                                       </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   90</td><td>    _txt = txt or &#39&#39                                                  </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   91</td><td>    if len(_txt) &lt max_len:                                           </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   92</td><td>        return _txt + &#39 &#39*(max_len-len(_txt))                         </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   93</td><td>    return _txt[0:max_len]                                            </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   94</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   95</td><td>def render(ln_old, s_old, mark, ln_new=None, s_new=None, fli_max_len=3</td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>     </td><td>, fls_max_length=63):                                                 </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   96</td><td>    if option_render_txt:                                             </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   97</td><td>        print \                                                       </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   98</td><td>            _fli(ln_old, max_len=fli_max_len), _fls(s_old, max_len=fls</td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>     </td><td>_max_length), \                                                       </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>   99</td><td>            mark, \                                                   </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  100</td><td>            _fli(ln_new, max_len=fli_max_len), _fls(s_new, max_len=fls</td><td>|</td><td class='ln_new'>  139</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>_max_length)                                                          </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  101</td><td>                                                                      </td><td>|</td><td class='ln_new'>  140</td><td>    for op in ops:                                                    </td></tr>
<tr class='mod'><td class='ln_old'>  102</td><td>    elif option_render_html:                                          </td><td>|</td><td class='ln_new'>  141</td><td>        typ, ln_old, ln_new, l = op                                   </td></tr>
<tr class='mod'><td class='ln_old'>  103</td><td>        if mark == &#39 &#39:                                               </td><td>|</td><td class='ln_new'>  142</td><td>        if typ == 2:                                                  </td></tr>
<tr class='mod'><td class='ln_old'>  104</td><td>            tr_cls = &#39sam&#39                                            </td><td>|</td><td class='ln_new'>  143</td><td>            print &#39&lttr&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lt/t</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>r&gt&#39%(&#39meta: ln_old:&#39, str(ln_old), &#39ln_new:&#39, str(ln_new))            </td></tr>
<tr class='mod'><td class='ln_old'>  105</td><td>        elif mark == &#39&gt&#39:                                             </td><td>|</td><td class='ln_new'>  144</td><td>        elif typ == -1:                                               </td></tr>
<tr class='mod'><td class='ln_old'>  106</td><td>            tr_cls = &#39add&#39                                            </td><td>|</td><td class='ln_new'>  145</td><td>            print &#39&lttr&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lt/t</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>r&gt&#39%(ln_old, &#39&#39, &#39-&#39, html_escape(l))                                 </td></tr>
<tr class='mod'><td class='ln_old'>  107</td><td>        elif mark == &#39&lt&#39:                                             </td><td>|</td><td class='ln_new'>  146</td><td>        elif typ == 0:                                                </td></tr>
<tr class='mod'><td class='ln_old'>  108</td><td>            tr_cls = &#39del&#39                                            </td><td>|</td><td class='ln_new'>  147</td><td>            print &#39&lttr&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lt/t</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>r&gt&#39%(ln_old, ln_new, &#39 &#39, html_escape(l))                             </td></tr>
<tr class='mod'><td class='ln_old'>  109</td><td>        elif mark == &#39|&#39:                                             </td><td>|</td><td class='ln_new'>  148</td><td>        elif typ == 1:                                                </td></tr>
<tr class='mod'><td class='ln_old'>  110</td><td>            tr_cls = &#39mod&#39                                            </td><td>|</td><td class='ln_new'>  149</td><td>            print &#39&lttr&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lt/t</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>r&gt&#39%(&#39&#39, ln_new, &#39+&#39, html_escape(l))                                 </td></tr>
<tr class='sam'><td class='ln_old'>  111</td><td>        else:                                                         </td><td> </td><td class='ln_new'>  150</td><td>        else:                                                         </td></tr>
<tr class='del'><td class='ln_old'>  112</td><td>            print &#39ERROR&#39, &#39show never happen&#39                        </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>  113</td><td>            tr_cls = &#39&#39                                               </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>  114</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>  115</td><td>        print &quot&lttr class=&#39%s&#39&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt/td&gt&lttd&gt%s&lt</td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>     </td><td>/td&gt&lttd&gt%s&lt/td&gt&lt/tr&gt&quot%(                                               </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='del'><td class='ln_old'>  116</td><td>            tr_cls,                                                   </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  117</td><td>            _fli(ln_old, max_len=fli_max_len), _fls(s_old, max_len=fls</td><td>|</td><td class='ln_new'>  151</td><td>            pass                                                      </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>_max_length),                                                         </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  118</td><td>            mark,                                                     </td><td>|</td><td class='ln_new'>  152</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  119</td><td>            _fli(ln_new, max_len=fli_max_len), _fls(s_new, max_len=fls</td><td>|</td><td class='ln_new'>  153</td><td>    print &#39&lt/table&gt&#39                                                  </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>_max_length)                                                          </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  120</td><td>        )                                                             </td><td>|</td><td class='ln_new'>  154</td><td>    print &#39&ltbr/&gt&#39                                                     </td></tr>
<tr class='mod'><td class='ln_old'>  121</td><td>                                                                      </td><td>|</td><td class='ln_new'>  155</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  122</td><td>    else:                                                             </td><td>|</td><td class='ln_new'>  156</td><td>if option_render_html:                                                </td></tr>
<tr class='mod'><td class='ln_old'>  123</td><td>        pass                                                          </td><td>|</td><td class='ln_new'>  157</td><td>    print &#39&lttable&gt&#39                                                   </td></tr>
<tr class='mod'><td class='ln_old'>  124</td><td>                                                                      </td><td>|</td><td class='ln_new'>  158</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  125</td><td>idx = 0                                                               </td><td> </td><td class='ln_new'>  159</td><td>idx = 0                                                               </td></tr>
<tr class='sam'><td class='ln_old'>  126</td><td>total = len(ops)                                                      </td><td> </td><td class='ln_new'>  160</td><td>total = len(ops)                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  127</td><td>                                                                      </td><td>|</td><td class='ln_new'>  161</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  128</td><td>if total == 0:                                                        </td><td> </td><td class='ln_new'>  162</td><td>if total == 0:                                                        </td></tr>
<tr class='sam'><td class='ln_old'>  129</td><td>    for i in xrange(1, ln_old_total+1):                               </td><td> </td><td class='ln_new'>  163</td><td>    for i in xrange(1, ln_old_total+1):                               </td></tr>
<tr class='sam'><td class='ln_old'>  130</td><td>        l = l_map[i]                                                  </td><td> </td><td class='ln_new'>  164</td><td>        l = l_map[i]                                                  </td></tr>
<tr class='sam'><td class='ln_old'>  131</td><td>        render(i, l, &#39 &#39, i, l)                                       </td><td> </td><td class='ln_new'>  165</td><td>        render(i, l, &#39 &#39, i, l)                                       </td></tr>
<tr class='mod'><td class='ln_old'>  132</td><td>                                                                      </td><td>|</td><td class='ln_new'>  166</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  133</td><td>    if option_render_html:                                            </td><td> </td><td class='ln_new'>  167</td><td>    if option_render_html:                                            </td></tr>
<tr class='sam'><td class='ln_old'>  134</td><td>        print &#39&lt/table&gt&#39                                              </td><td> </td><td class='ln_new'>  168</td><td>        print &#39&lt/table&gt&#39                                              </td></tr>
<tr class='mod'><td class='ln_old'>  135</td><td>                                                                      </td><td>|</td><td class='ln_new'>  169</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  136</td><td>    sys.exit(0)                                                       </td><td> </td><td class='ln_new'>  170</td><td>    sys.exit(0)                                                       </td></tr>
<tr class='mod'><td class='ln_old'>  137</td><td>                                                                      </td><td>|</td><td class='ln_new'>  171</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  138</td><td>while idx &lt total:                                                    </td><td> </td><td class='ln_new'>  172</td><td>while idx &lt total:                                                    </td></tr>
<tr class='del'><td class='ln_old'>  139</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  140</td><td>    op = ops[idx]                                                     </td><td> </td><td class='ln_new'>  173</td><td>    op = ops[idx]                                                     </td></tr>
<tr class='sam'><td class='ln_old'>  141</td><td>    typ, ln_old, ln_new, l = op                                       </td><td> </td><td class='ln_new'>  174</td><td>    typ, ln_old, ln_new, l = op                                       </td></tr>
<tr class='del'><td class='ln_old'>  142</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  143</td><td>    if typ == &#39M&#39:                                                    </td><td>|</td><td class='ln_new'>  175</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  144</td><td>                                                                      </td><td>|</td><td class='ln_new'>  176</td><td>    if typ == 2:                # hunk meta line                      </td></tr>
<tr class='sam'><td class='ln_old'>  145</td><td>        # fill up lines missing between hunks                         </td><td> </td><td class='ln_new'>  177</td><td>        # fill up lines missing between hunks                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  178</td><td>        n = 0                                                         </td></tr>
<tr class='sam'><td class='ln_old'>  146</td><td>        for i in xrange(int(ln_old_last+1), int(ln_old)):             </td><td> </td><td class='ln_new'>  179</td><td>        for i in xrange(int(ln_old_last+1), int(ln_old)):             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  180</td><td>            n += 1                                                    </td></tr>
<tr class='sam'><td class='ln_old'>  147</td><td>            l = l_map[i]                                              </td><td> </td><td class='ln_new'>  181</td><td>            l = l_map[i]                                              </td></tr>
<tr class='mod'><td class='ln_old'>  148</td><td>            render(ln_old, l, &#39 &#39, ln_new, l)                         </td><td>|</td><td class='ln_new'>  182</td><td>            render(ln_old_last+n, l, &#39&#39, ln_new_last + n, l)          </td></tr>
<tr class='mod'><td class='ln_old'>  149</td><td>                                                                      </td><td>|</td><td class='ln_new'>  183</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  150</td><td>        idx += 1                                                      </td><td> </td><td class='ln_new'>  184</td><td>        idx += 1                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  151</td><td>        continue                                                      </td><td> </td><td class='ln_new'>  185</td><td>        continue                                                      </td></tr>
<tr class='del'><td class='ln_old'>  152</td><td>                                                                      </td><td>-</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  153</td><td>    # &#39L&#39                                                             </td><td>|</td><td class='ln_new'>  186</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  154</td><td>                                                                      </td><td>|</td><td class='ln_new'>  187</td><td>    # else, data lines                                                </td></tr>
<tr class='sam'><td class='ln_old'>  155</td><td>    if ln_old is not None:                                            </td><td> </td><td class='ln_new'>  188</td><td>    if ln_old is not None:                                            </td></tr>
<tr class='sam'><td class='ln_old'>  156</td><td>        ln_old_last = ln_old                                          </td><td> </td><td class='ln_new'>  189</td><td>        ln_old_last = ln_old                                          </td></tr>
<tr class='sam'><td class='ln_old'>  157</td><td>    if ln_new is not None:                                            </td><td> </td><td class='ln_new'>  190</td><td>    if ln_new is not None:                                            </td></tr>
<tr class='sam'><td class='ln_old'>  158</td><td>        ln_new_last = ln_new                                          </td><td> </td><td class='ln_new'>  191</td><td>        ln_new_last = ln_new                                          </td></tr>
<tr class='mod'><td class='ln_old'>  159</td><td>                                                                      </td><td>|</td><td class='ln_new'>  192</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  160</td><td>    is_flsame = ln_old and ln_new                                     </td><td>|</td><td class='ln_new'>  193</td><td>    if typ == -1:               # minus &#39-&#39                           </td></tr>
<tr class='mod'><td class='ln_old'>  161</td><td>    is_minus = not is_flsame and ln_old and not ln_new                </td><td>|</td><td class='ln_new'>  194</td><td>        # consume consequent &#39-&#39 as much as possible                  </td></tr>
<tr class='mod'><td class='ln_old'>  162</td><td>    is_plus = not is_flsame and not ln_old and ln_new                 </td><td>|</td><td class='ln_new'>  195</td><td>        idx2 = idx + 1                                                </td></tr>
<tr class='mod'><td class='ln_old'>  163</td><td>                                                                      </td><td>|</td><td class='ln_new'>  196</td><td>        while idx2 &lt total and ops[idx2][0] == -1:                    </td></tr>
<tr class='mod'><td class='ln_old'>  164</td><td>    if is_minus:                                                      </td><td>|</td><td class='ln_new'>  197</td><td>            idx2 += 1                                                 </td></tr>
<tr class='mod'><td class='ln_old'>  165</td><td>                                                                      </td><td>|</td><td class='ln_new'>  198</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  166</td><td>        if idx+1 == total:      # last one                            </td><td>|</td><td class='ln_new'>  199</td><td>        if idx2 == total:       # idx2 exceeds ops, which means, all f</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td>rom idx is &#39-&#39                                                        </td></tr>
<tr class='mod'><td class='ln_old'>  167</td><td>            render(ln_old, op[3], &#39&lt&#39)                                </td><td>|</td><td class='ln_new'>  200</td><td>            for _op in ops[idx: idx2]:                                </td></tr>
<tr class='mod'><td class='ln_old'>  168</td><td>            break                                                     </td><td>|</td><td class='ln_new'>  201</td><td>                _typ, _lno, _lnn, _l = _op                            </td></tr>
<tr class='mod'><td class='ln_old'>  169</td><td>                                                                      </td><td>|</td><td class='ln_new'>  202</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  170</td><td>        # KEY: probe next op if current is &#39-&#39 to see if it&#39s &#39+&#39     </td><td>|</td><td class='ln_new'>  203</td><td>                if _lno: ln_old_last = _lno                           </td></tr>
<tr class='mod'><td class='ln_old'>  171</td><td>        next_op = ops[idx+1]                                          </td><td>|</td><td class='ln_new'>  204</td><td>                if _lnn: ln_new_last = _lnn                           </td></tr>
<tr class='mod'><td class='ln_old'>  172</td><td>        next_typ, next_ln_old, next_ln_new, next_l = next_op          </td><td>|</td><td class='ln_new'>  205</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  173</td><td>                                                                      </td><td>|</td><td class='ln_new'>  206</td><td>                render(_lno, _l, &#39-&#39)                                 </td></tr>
<tr class='mod'><td class='ln_old'>  174</td><td>        next_is_flsame = next_ln_old and next_ln_new                  </td><td>|</td><td class='ln_new'>  207</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  175</td><td>        next_is_minus = not next_is_flsame and next_ln_old and not nex</td><td>|</td><td class='ln_new'>  208</td><td>            # print &#39dia: idx2 = %d, total = %d&#39%(idx2, total)        </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>t_ln_new                                                              </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  176</td><td>        next_is_plus = not next_is_flsame and not next_ln_old and next</td><td>|</td><td class='ln_new'>  209</td><td>            break               # all done, just break main loop      </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>_ln_new                                                               </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  177</td><td>                                                                      </td><td>|</td><td class='ln_new'>  210</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  178</td><td>        if next_is_plus:                                              </td><td>|</td><td class='ln_new'>  211</td><td>        if ops[idx2][0] == 0:   # idx2 points to first &#39 &#39 after bunch</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td> of &#39-&#39                                                               </td></tr>
<tr class='mod'><td class='ln_old'>  179</td><td>            render(ln_old, op[3], &#39|&#39, ln_new or ln_new_last+1, next_o</td><td>|</td><td class='ln_new'>  212</td><td>            for _op in ops[idx: idx2]:                                </td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>p[3])                                                                 </td><td>|</td><td class='ln_new'>     </td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  180</td><td>            idx += 2                                                  </td><td>|</td><td class='ln_new'>  213</td><td>                _typ, _lno, _lnn, _l = _op                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  215</td><td>                if _lno: ln_old_last = _lno                           </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  216</td><td>                if _lnn: ln_new_last = _lnn                           </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  218</td><td>                render(_lno, _l, &#39-&#39)                                 </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  220</td><td>            # go on to next round                                     </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  221</td><td>            idx = idx2                                                </td></tr>
<tr class='sam'><td class='ln_old'>  181</td><td>            continue                                                  </td><td> </td><td class='ln_new'>  222</td><td>            continue                                                  </td></tr>
<tr class='mod'><td class='ln_old'>  182</td><td>        else:                                                         </td><td>|</td><td class='ln_new'>  223</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  183</td><td>            render(ln_old, op[3], &#39&lt&#39)                                </td><td>|</td><td class='ln_new'>  224</td><td>        if ops[idx2][0] == 1:   # idx2 points to first &#39+&#39 after bunch</td></tr>
<tr class='mod'><td class='ln_old'>     </td><td>                                                                      </td><td>|</td><td class='ln_new'>     </td><td> of &#39-&#39                                                               </td></tr>
<tr class='mod'><td class='ln_old'>  184</td><td>            idx += 1                                                  </td><td>|</td><td class='ln_new'>  225</td><td>            # consume consequent &#39+&#39 as much as possible              </td></tr>
<tr class='mod'><td class='ln_old'>  185</td><td>            continue                                                  </td><td>|</td><td class='ln_new'>  226</td><td>            idx3 = idx2 + 1                                           </td></tr>
<tr class='mod'><td class='ln_old'>  186</td><td>                                                                      </td><td>|</td><td class='ln_new'>  227</td><td>            while idx3 &lt total and ops[idx3][0] == 1:                 </td></tr>
<tr class='mod'><td class='ln_old'>  187</td><td>    if is_plus:                                                       </td><td>|</td><td class='ln_new'>  228</td><td>                idx3 += 1                                             </td></tr>
<tr class='mod'><td class='ln_old'>  188</td><td>        render(ln_old, &#39&#39, &#39&gt&#39, ln_new, op[3])                        </td><td>|</td><td class='ln_new'>  229</td><td>                                                                      </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  230</td><td>            # either idx3 is last op, or points to &#39 &#39, &#39-&#39,          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  231</td><td>            # we all terminate this round                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  233</td><td>            n_minus = idx2 - idx                                      </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  234</td><td>            n_plus = idx3 - idx2                                      </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  236</td><td>            if n_minus &lt= n_plus:                                     </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  237</td><td>                # cosume both n_minus count of &#39-&#39 ops and n_minus cou</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>nt of &#39+&#39 ops                                                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  238</td><td>                for _i in xrange(0, n_minus):                         </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  239</td><td>                    _, _lno_l, _lnn_l, _l_l = ops[idx+_i]             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  240</td><td>                    _, _lno_r, _lnn_r, _l_r = ops[idx2+_i]            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  242</td><td>                    if _lno_l: ln_old_last = _lno_l                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  243</td><td>                    if _lnn_r: ln_new_last = _lnn_r                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  245</td><td>                    render(_lno_l, _l_l, &#39|&#39, _lnn_r, _l_r)           </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  247</td><td>                for _op in ops[idx2+n_minus:idx3]: # idx3 not cosumned</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  248</td><td>                    _typ, _lno, _lnn, _l = _op                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  250</td><td>                    if _lno: ln_old_last = _lno                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  251</td><td>                    if _lnn: ln_new_last = _lnn                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  253</td><td>                    render(None, &#39&#39, &#39+&#39, _lnn, _l)                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  255</td><td>                # go on to next round                                 </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  256</td><td>                idx = idx3                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  257</td><td>                continue                                              </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  259</td><td>            else:               # n_minus &gt n_plus                    </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  260</td><td>                for _op in ops[idx:idx+n_minus-n_plus]:               </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  261</td><td>                    _typ, _lno, _lnn, _l = _op                        </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  263</td><td>                    if _lno: ln_old_last = _lno                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  264</td><td>                    if _lnn: ln_new_last = _lnn                       </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  266</td><td>                    render(_lno, _l, &#39-&#39)                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  268</td><td>                # cosume both n_plus count of &#39-&#39 ops and n_minus coun</td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>     </td><td>t of &#39+&#39 ops                                                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  269</td><td>                _idx = idx+n_minus-n_plus                             </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  270</td><td>                for _i in xrange(0, n_plus):                          </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  271</td><td>                    _, _lno_l, _lnn_l, _l_l = ops[_idx+_i]            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  272</td><td>                    _, _lno_r, _lnn_r, _l_r = ops[idx2+_i]            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  274</td><td>                    if _lno_l: ln_old_last = _lno_l                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  275</td><td>                    if _lnn_r: ln_new_last = _lnn_r                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  277</td><td>                    render(_lno_l, _l_l, &#39|&#39, _lnn_r, _l_r)           </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  280</td><td>                # go on to next round                                 </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  281</td><td>                idx = idx3                                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  282</td><td>                continue                                              </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  284</td><td>    if typ == 1:                # plus &#39+&#39                            </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  285</td><td>        render(ln_old, &#39&#39, &#39+&#39, ln_new, op[3])                        </td></tr>
<tr class='sam'><td class='ln_old'>  189</td><td>        idx += 1                                                      </td><td> </td><td class='ln_new'>  286</td><td>        idx += 1                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  190</td><td>        continue                                                      </td><td> </td><td class='ln_new'>  287</td><td>        continue                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  191</td><td>                                                                      </td><td>|</td><td class='ln_new'>  288</td><td>                                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  192</td><td>    if is_flsame:                                                     </td><td>|</td><td class='ln_new'>  289</td><td>    if typ == 0:                # space/same &#39 &#39                      </td></tr>
<tr class='sam'><td class='ln_old'>  193</td><td>        render(ln_old, op[3], &#39 &#39, ln_new, op[3])                     </td><td> </td><td class='ln_new'>  290</td><td>        render(ln_old, op[3], &#39 &#39, ln_new, op[3])                     </td></tr>
<tr class='sam'><td class='ln_old'>  194</td><td>        idx += 1                                                      </td><td> </td><td class='ln_new'>  291</td><td>        idx += 1                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  195</td><td>        continue                                                      </td><td> </td><td class='ln_new'>  292</td><td>        continue                                                      </td></tr>
<tr class='mod'><td class='ln_old'>  196</td><td>                                                                      </td><td>|</td><td class='ln_new'>  293</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  197</td><td># padding last parts (not included in hunk) if exists from old file   </td><td> </td><td class='ln_new'>  294</td><td># padding last parts (not included in hunk) if exists from old file   </td></tr>
<tr class='sam'><td class='ln_old'>  198</td><td>if ln_old_last &gt 0:             # means have been re-assigned by &#39L&#39 t</td><td> </td><td class='ln_new'>  295</td><td>if ln_old_last &gt 0:             # means have been re-assigned by &#39L&#39 t</td></tr>
<tr class='sam'><td class='ln_old'>     </td><td>ype meta                                                              </td><td> </td><td class='ln_new'>     </td><td>ype meta                                                              </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  296</td><td>    n = 0                                                             </td></tr>
<tr class='sam'><td class='ln_old'>  199</td><td>    for i in xrange(ln_old_last+1, ln_old_total+1):                   </td><td> </td><td class='ln_new'>  297</td><td>    for i in xrange(ln_old_last+1, ln_old_total+1):                   </td></tr>
<tr class='add'><td class='ln_old'>     </td><td>                                                                      </td><td>+</td><td class='ln_new'>  298</td><td>        n += 1                                                        </td></tr>
<tr class='sam'><td class='ln_old'>  200</td><td>        l = l_map[i]                                                  </td><td> </td><td class='ln_new'>  299</td><td>        l = l_map[i]                                                  </td></tr>
<tr class='mod'><td class='ln_old'>  201</td><td>        render(i, l, &#39 &#39, i, l)                                       </td><td>|</td><td class='ln_new'>  300</td><td>        render(i, l, &#39&#39)                                              </td></tr>
<tr class='mod'><td class='ln_old'>  202</td><td>                                                                      </td><td>|</td><td class='ln_new'>  301</td><td>                                                                      </td></tr>
<tr class='sam'><td class='ln_old'>  203</td><td>if option_render_html:                                                </td><td> </td><td class='ln_new'>  302</td><td>if option_render_html:                                                </td></tr>
<tr class='sam'><td class='ln_old'>  204</td><td>    print &#39&lt/table&gt&#39                                                  </td><td> </td><td class='ln_new'>  303</td><td>    print &#39&lt/table&gt&#39                                                  </td></tr>
</table>
